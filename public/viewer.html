<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EARTI Media Viewer</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <!-- Firebase Authentication -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDHVRDEvVc1qEat2Kdc8axh4NLhgj9QaPg",
      authDomain: "earti-1.web.app",
      projectId: "earti-1",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <!-- Authentication UI -->
  <div id="authContainer" style="text-align: center; padding: 2rem;">
    <button id="signInBtn">Sign in with Google</button>
    <button id="signOutBtn" style="display: none;">Sign out</button>
    <p id="userInfo"></p>
    <div id="loadingAuth" style="display: none; margin: 1rem 0;">
      <div class="loading-indicator"></div>
      <p>Checking authentication and authorization...</p>
    </div>
    <div id="unauthorizedMessage" style="display: none; margin: 1rem 0; padding: 1rem; background: #ffebee; border: 1px solid #f44336; border-radius: 4px; color: #c62828;">
      <h3>Access Denied</h3>
      <p>Your email address is not authorized to access this system. Please contact the administrator if you believe this is an error.</p>
      <p id="unauthorizedEmail" style="font-weight: bold;"></p>
      <button onclick="window.location.href='index.html'" style="margin-top: 1rem;">← Back to Main Page</button>
    </div>
  </div>

  <!-- Main content - hidden by default -->
  <div class="container" id="mainContainer" style="display: none;">
    <div style="text-align: center; margin-bottom: 1rem;">
      <button id="backBtn" onclick="window.location.href='index.html'" 
              style="margin-right: 1rem;">← Back to EARTI Selection</button>
      <button id="signOutBtn2">Sign out</button>
      <p id="userInfo2"></p>
    </div>

    <div class="camera-selector">
      <label for="cameraSelect">Choose camera view:</label>
      <select id="cameraSelect">
        <option value="cam1">Camera 1</option>
        <option value="cam2">Camera 2</option>
        <option value="both">Both</option>
      </select>
    </div>

    <div id="videoContainer" class="video-container"></div>
    <div id="controlsContainer" class="controls-container"></div>
  </div>

  <script>
    // Initialize Firebase services
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // UI elements
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const signOutBtn2 = document.getElementById("signOutBtn2");
    const userInfo = document.getElementById("userInfo");
    const userInfo2 = document.getElementById("userInfo2");
    const authContainer = document.getElementById("authContainer");
    const mainContainer = document.getElementById("mainContainer");
    const loadingAuth = document.getElementById("loadingAuth");
    const unauthorizedMessage = document.getElementById("unauthorizedMessage");
    const unauthorizedEmail = document.getElementById("unauthorizedEmail");

    // Hardcoded authorized emails (should match index.html)
    const AUTHORIZED_EMAILS = [
      'your-email@gmail.com',
      'admin@yourdomain.com',
      'authorized-user@example.com'
      // Add more authorized emails here
    ];

    // Show loading initially
    loadingAuth.style.display = "block";
    signInBtn.style.display = "none";

    // Function to check if email is authorized
    async function isEmailAuthorized(email) {
      // First check hardcoded list
      if (AUTHORIZED_EMAILS.includes(email.toLowerCase())) {
        return true;
      }

      // Optionally, also check Firestore database
      try {
        const doc = await db.collection('authorized_users').doc(email.toLowerCase()).get();
        return doc.exists && doc.data().authorized === true;
      } catch (error) {
        console.error('Error checking authorization in database:', error);
        return false;
      }
    }

    // Function to validate access before loading streams
    function validateStreamAccess() {
      const user = auth.currentUser;
      const userAuthorized = localStorage.getItem("userAuthorized");
      const authorizedEmail = localStorage.getItem("authorizedEmail");
      
      if (!user || !userAuthorized || !authorizedEmail || user.email !== authorizedEmail) {
        console.error("Unauthorized stream access attempt");
        alert("Unauthorized access detected. Redirecting to login.");
        window.location.href = "index.html";
        return false;
      }
      
      return true;
    }

    // Function to log stream access
    async function logStreamAccess(user, eartiId, cameraSelection) {
      try {
        await db.collection('stream_access_logs').add({
          email: user.email,
          displayName: user.displayName,
          uid: user.uid,
          eartiId: eartiId,
          cameraSelection: cameraSelection,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          userAgent: navigator.userAgent,
          sessionId: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
        });
        console.log('Logged stream access');
      } catch (error) {
        console.error('Error logging stream access:', error);
      }
    }

    // Sign in handler
    const signInHandler = () => {
      loadingAuth.style.display = "block";
      signInBtn.style.display = "none";
      unauthorizedMessage.style.display = "none";
      
      auth.signInWithPopup(provider).catch(error => {
        console.error("Sign-in failed:", error);
        alert("Sign-in failed: " + error.message);
        loadingAuth.style.display = "none";
        signInBtn.style.display = "inline-block";
      });
    };

    // Sign out handler
    const signOutHandler = () => {
      auth.signOut().then(() => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    };

    signInBtn.onclick = signInHandler;
    signOutBtn.onclick = signOutHandler;
    signOutBtn2.onclick = signOutHandler;

    // Authentication state listener
    auth.onAuthStateChanged(async (user) => {
      loadingAuth.style.display = "none";
      
      if (user) {
        console.log("User authenticated:", user.email);
        
        // Check if user is authorized
        const authorized = await isEmailAuthorized(user.email);
        
        if (authorized) {
          console.log("User authorized:", user.email);
          
          // Store authorization status
          localStorage.setItem("userAuthorized", "true");
          localStorage.setItem("authorizedEmail", user.email);
          
          // Show main content
          authContainer.style.display = "none";
          mainContainer.style.display = "block";
          
          // Update user info
          userInfo2.textContent = `Signed in as ${user.displayName} (${user.email})`;
          signOutBtn2.style.display = "inline-block";
          
          // Initialize the viewer functionality
          initializeViewer();
          
        } else {
          console.warn("User not authorized:", user.email);
          
          // Show unauthorized message
          authContainer.style.display = "block";
          mainContainer.style.display = "none";
          signInBtn.style.display = "none";
          signOutBtn.style.display = "inline-block";
          unauthorizedMessage.style.display = "block";
          unauthorizedEmail.textContent = user.email;
          userInfo.textContent = `Signed in as ${user.displayName}`;
          
          // Clear any stored data
          localStorage.clear();
        }
      } else {
        // Not signed in - redirect to main page
        console.log("User not authenticated, redirecting...");
        window.location.href = "index.html";
      }
    });

    // Initialize viewer functionality after authentication
    function initializeViewer() {
      console.log("Initializing viewer...");
      
      // Double-check authorization
      if (!validateStreamAccess()) {
        return;
      }
      
      // Check if user selected an EARTI
      const selectedEarti = localStorage.getItem("selectedEarti");
      if (!selectedEarti) {
        console.warn("No EARTI selected, redirecting to selection page");
        window.location.href = "index.html";
        return;
      }
      
      console.log("Selected EARTI:", selectedEarti);
      
      // Add EARTI selector
      const cameraSelector = document.querySelector('.camera-selector');
      let eartiSelect = document.getElementById('eartiSelect');
      
      if (!eartiSelect) {
        const eartiSelectorDiv = document.createElement('div');
        eartiSelectorDiv.style.marginBottom = '1rem';
        
        const eartiLabel = document.createElement('label');
        eartiLabel.textContent = 'Selected EARTI: ';
        eartiLabel.style.marginRight = '0.5rem';
        
        eartiSelect = document.createElement('select');
        eartiSelect.id = 'eartiSelect';
        eartiSelect.innerHTML = `
          <option value="earti1" ${selectedEarti === 'earti1' ? 'selected' : ''}>EARTI 1</option>
          <option value="earti2" ${selectedEarti === 'earti2' ? 'selected' : ''}>EARTI 2</option>
        `;
        
        eartiSelectorDiv.appendChild(eartiLabel);
        eartiSelectorDiv.appendChild(eartiSelect);
        cameraSelector.insertBefore(eartiSelectorDiv, cameraSelector.firstChild);
      }
      
      // Set the selected EARTI
      eartiSelect.value = selectedEarti;
      
      // Log initial access
      const cameraSelect = document.getElementById('cameraSelect');
      logStreamAccess(auth.currentUser, selectedEarti, cameraSelect.value);
    }

    // Enhanced security checks
    setInterval(async () => {
      const user = auth.currentUser;
      if (user && mainContainer.style.display !== "none") {
        // Check if still authorized
        const stillAuthorized = await isEmailAuthorized(user.email);
        if (!stillAuthorized) {
          console.warn("User authorization revoked:", user.email);
          alert("Your access has been revoked. You will be signed out.");
          auth.signOut();
          return;
        }
        
        // Validate stream access
        if (!validateStreamAccess()) {
          return;
        }
      }
    }, 60000); // Check every minute

    // Prevent unauthorized access via direct URL manipulation
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (!auth.currentUser || !localStorage.getItem("userAuthorized")) {
          console.warn("Direct access attempt without proper authentication");
          window.location.href = "index.html";
        }
      }, 2000);
    });

    // Clear data on page unload for security
    window.addEventListener('beforeunload', () => {
      if (!localStorage.getItem("userAuthorized")) {
        localStorage.clear();
      }
    });
  </script>

  <script src="script.js"></script>
</body>
</html>